<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Sign in</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    body {
      font-family: system-ui, -apple-system, sans-serif;
      background: #f6f7f9;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      margin: 0;
    }

    .card {
      background: white;
      padding: 32px;
      width: 100%;
      max-width: 420px;
      border-radius: 8px;
      box-shadow: 0 8px 20px rgba(0,0,0,.08);
    }

    h1 {
      font-size: 22px;
      margin-bottom: 12px;
    }

    p {
      color: #555;
      line-height: 1.5;
      margin-bottom: 20px;
    }

    input {
      width: 100%;
      padding: 12px;
      font-size: 16px;
      border: 1px solid #ddd;
      border-radius: 6px;
      margin-bottom: 16px;
    }

    button {
      width: 100%;
      padding: 12px;
      font-size: 16px;
      font-weight: 600;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      margin-top: 8px;
    }

    .primary {
      background: #2563eb;
      color: white;
    }

    .secondary {
      background: #6c757d;
      color: white;
      margin-top: 12px;
    }

    .hidden {
      display: none;
    }

    .msg {
      margin-top: 16px;
      padding: 12px;
      border-radius: 6px;
      font-size: 14px;
    }

    .error {
      background: #fee2e2;
      color: #7f1d1d;
    }

    .info {
      background: #e0f2fe;
      color: #075985;
    }
  </style>
</head>
<body>

<div class="card">
  <h1>Sign in</h1>

  <p id="intro">
    Sign in with a passkey
  </p>

  <!-- Autocomplete input for conditional UI -->
  <input type="text" id="username" autocomplete="username webauthn" placeholder="Choose a passkey...">

  <button id="registerBtn" class="secondary">
    Create new passkey
  </button>

  <div id="msg" class="msg hidden"></div>
</div>

<script>
/* ---------------- helpers ---------------- */

function showMessage(text, type = "info") {
  const el = document.getElementById("msg");
  el.textContent = text;
  el.className = `msg ${type}`;
  el.classList.remove("hidden");
}

function hideMessage() {
  document.getElementById("msg").classList.add("hidden");
}

/* base64url helpers */
function b64urlToBuf(v) {
  const pad = "=".repeat((4 - v.length % 4) % 4);
  const b64 = (v + pad).replace(/-/g, "+").replace(/_/g, "/");
  const bin = atob(b64);
  const buf = new Uint8Array(bin.length);
  for (let i = 0; i < bin.length; i++) buf[i] = bin.charCodeAt(i);
  return buf.buffer;
}

function bufToB64url(buf) {
  const bytes = new Uint8Array(buf);
  let bin = "";
  for (const b of bytes) bin += String.fromCharCode(b);
  return btoa(bin).replace(/\+/g, "-").replace(/\//g, "_").replace(/=+$/, "");
}

/* ---------------- REGISTRATION ---------------- */

async function registerPasskey() {
  hideMessage();
  showMessage("Creating passkey...", "info");

  try {
    const res = await fetch("/auth/passkey/register/options", { 
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({})
    });
    const opts = await res.json();

    opts.challenge = b64urlToBuf(opts.challenge);
    opts.user.id = b64urlToBuf(opts.user.id);

    // FORCE platform authenticator - no QR code EVER
    opts.authenticatorSelection = {
      authenticatorAttachment: 'platform',
      requireResidentKey: true,
      residentKey: 'required',
      userVerification: 'required'
    };

    // Force specific algorithms
    opts.pubKeyCredParams = [
      { type: 'public-key', alg: -7 },
      { type: 'public-key', alg: -257 }
    ];

    const cred = await navigator.credentials.create({
      publicKey: opts
    });

    const payload = {
      id: cred.id,
      rawId: bufToB64url(cred.rawId),
      type: cred.type,
      response: {
        clientDataJSON: bufToB64url(cred.response.clientDataJSON),
        attestationObject: bufToB64url(cred.response.attestationObject)
      }
    };

    const verify = await fetch("/auth/passkey/register/verify", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ credential: payload })
    });

    const result = await verify.json();

    if (!result.success) {
      throw new Error(result.error || "Registration failed");
    }

    showMessage("Passkey created. Signed in.");
    setTimeout(() => window.location = "/", 800);

  } catch (err) {
    if (err.name === "NotAllowedError") {
      showMessage("Passkey creation cancelled", "error");
    } else {
      showMessage(err.message || "Could not create passkey", "error");
    }
  }
}

document.getElementById("registerBtn").onclick = () => registerPasskey();

/* ---------------- CONDITIONAL UI LOGIN ---------------- */

async function setupConditionalUI() {
  try {
    // Check if conditional UI is supported
    const available = await PublicKeyCredential.isConditionalMediationAvailable();
    
    if (!available) {
      // Fallback to button-based login
      console.log("Conditional UI not supported");
      return;
    }

    const res = await fetch("/auth/passkey/login/options", { method: "POST" });
    const opts = await res.json();

    opts.challenge = b64urlToBuf(opts.challenge);

    // Start conditional UI - this populates the autocomplete dropdown
    const cred = await navigator.credentials.get({
      publicKey: opts,
      mediation: 'conditional'  // This shows passkeys in autocomplete, no QR!
    });

    const payload = {
      id: cred.id,
      rawId: bufToB64url(cred.rawId),
      type: cred.type,
      response: {
        clientDataJSON: bufToB64url(cred.response.clientDataJSON),
        authenticatorData: bufToB64url(cred.response.authenticatorData),
        signature: bufToB64url(cred.response.signature),
        userHandle: cred.response.userHandle
          ? bufToB64url(cred.response.userHandle)
          : null
      }
    };

    const verify = await fetch("/auth/passkey/login/verify", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ credential: payload })
    });

    const result = await verify.json();

    if (result.success) {
      showMessage("Signed in. Redirectingâ€¦");
      setTimeout(() => window.location = "/", 800);
    }

  } catch (err) {
    console.log("Conditional UI error:", err);
  }
}

// Start conditional UI on page load
setupConditionalUI();
</script>

</body>
</html>