<!DOCTYPE html>
<html>
<head>
    <title>Dashboard</title>
    <style>
        * { box-sizing: border-box; }
        body { font-family: system-ui, sans-serif; max-width: 500px; margin: 40px auto; padding: 20px; }
        h1 { margin-bottom: 8px; }
        .subtitle { color: #666; margin-bottom: 24px; }
        .card { background: #f8f9fa; border-radius: 8px; padding: 20px; margin: 16px 0; }
        .card h3 { margin: 0 0 12px 0; }
        button { padding: 10px 20px; border: none; border-radius: 6px; font-size: 14px; cursor: pointer; margin-right: 8px; }
        .primary { background: #4285f4; color: white; }
        .danger { background: #ea4335; color: white; }
        .secondary { background: #e8eaed; color: #333; }
        button:hover { opacity: 0.9; }
        button:disabled { opacity: 0.5; }
        .status { padding: 12px; margin: 12px 0; border-radius: 6px; display: none; }
        .status.show { display: block; }
        .status.error { background: #fce8e6; color: #c5221f; }
        .status.success { background: #e6f4ea; color: #137333; }
        .badge { display: inline-block; padding: 4px 8px; border-radius: 4px; font-size: 12px; }
        .badge.on { background: #e6f4ea; color: #137333; }
        .badge.off { background: #fce8e6; color: #c5221f; }
        .backup-codes { font-family: monospace; background: #fff; padding: 12px; border-radius: 4px; margin-top: 12px; }
        .backup-codes code { display: block; padding: 4px 0; }
        #qr-code img { max-width: 200px; margin: 12px 0; }
        #totp-secret { font-family: monospace; background: #fff; padding: 8px; border-radius: 4px; word-break: break-all; }
        input[type="text"] { padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 16px; width: 150px; }
    </style>
</head>
<body>
    <h1>Dashboard</h1>
    <p class="subtitle">User #{{ user.id }}</p>

    <div id="status" class="status"></div>

    <div class="card">
        <h3>Two-Factor Authentication 
            <span class="badge {{ 'on' if has_2fa else 'off' }}">{{ 'Enabled' if has_2fa else 'Disabled' }}</span>
        </h3>
        
        {% if has_2fa %}
        <button id="disable-2fa" class="danger">Disable 2FA</button>
        {% else %}
        <div id="setup-2fa-section">
            <button id="setup-2fa" class="primary">Enable 2FA</button>
        </div>
        <div id="verify-2fa-section" style="display:none;">
            <div id="qr-code"></div>
            <p>Secret: <span id="totp-secret"></span></p>
            <p>Enter code from authenticator:</p>
            <input type="text" id="totp-code" placeholder="000000" maxlength="6">
            <button id="verify-2fa" class="primary">Verify</button>
            <div id="backup-codes" class="backup-codes" style="display:none;"></div>
        </div>
        {% endif %}
    </div>

    <div class="card">
        <h3>Session</h3>
        <a href="/logout"><button class="secondary">Logout</button></a>
    </div>

    <script>
        const status = document.getElementById('status');
        
        function showStatus(msg, isError = false) {
            status.textContent = msg;
            status.className = 'status show ' + (isError ? 'error' : 'success');
            setTimeout(() => status.className = 'status', 3000);
        }

        {% if not has_2fa %}
        const setupBtn = document.getElementById('setup-2fa');
        const setupSection = document.getElementById('setup-2fa-section');
        const verifySection = document.getElementById('verify-2fa-section');
        const verifyBtn = document.getElementById('verify-2fa');
        const codeInput = document.getElementById('totp-code');
        const backupCodesDiv = document.getElementById('backup-codes');

        setupBtn.onclick = async () => {
            setupBtn.disabled = true;
            try {
                const res = await fetch('/auth/2fa/setup');
                const data = await res.json();
                document.getElementById('qr-code').innerHTML = `<img src="${data.qr_code}">`;
                document.getElementById('totp-secret').textContent = data.secret;
                setupSection.style.display = 'none';
                verifySection.style.display = 'block';
            } catch (e) {
                showStatus(e.message, true);
            }
            setupBtn.disabled = false;
        };

        verifyBtn.onclick = async () => {
            verifyBtn.disabled = true;
            try {
                const res = await fetch('/auth/2fa/setup', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ code: codeInput.value })
                });
                const data = await res.json();
                if (data.success) {
                    showStatus('2FA enabled!');
                    backupCodesDiv.style.display = 'block';
                    backupCodesDiv.innerHTML = '<strong>Backup codes (save these!):</strong>' + 
                        data.backup_codes.map(c => `<code>${c}</code>`).join('');
                    verifyBtn.style.display = 'none';
                    codeInput.style.display = 'none';
                } else {
                    showStatus(data.error || 'Invalid code', true);
                }
            } catch (e) {
                showStatus(e.message, true);
            }
            verifyBtn.disabled = false;
        };
        {% endif %}

        {% if has_2fa %}
        document.getElementById('disable-2fa').onclick = async () => {
            if (!confirm('Disable 2FA?')) return;
            try {
                const res = await fetch('/auth/2fa/disable', { method: 'POST' });
                const data = await res.json();
                if (data.success) {
                    window.location.reload();
                }
            } catch (e) {
                showStatus(e.message, true);
            }
        };
        {% endif %}
    </script>
</body>
</html>
