<!DOCTYPE html>
<html>
<head>
    <title>Verify 2FA</title>
    <style>
        * { box-sizing: border-box; }
        body { font-family: system-ui, sans-serif; max-width: 400px; margin: 80px auto; padding: 20px; }
        h1 { margin-bottom: 8px; }
        .subtitle { color: #666; margin-bottom: 24px; }
        input[type="text"] { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 18px; text-align: center; letter-spacing: 4px; margin-bottom: 16px; }
        button { width: 100%; padding: 12px; border: none; border-radius: 6px; font-size: 16px; cursor: pointer; margin-bottom: 8px; }
        .primary { background: #4285f4; color: white; }
        .secondary { background: #f1f3f4; color: #333; }
        button:hover { opacity: 0.9; }
        button:disabled { opacity: 0.5; }
        .status { padding: 12px; margin: 16px 0; border-radius: 6px; display: none; }
        .status.error { display: block; background: #fce8e6; color: #c5221f; }
        .toggle { text-align: center; margin-top: 16px; }
        .toggle a { color: #4285f4; cursor: pointer; }
    </style>
</head>
<body>
    <h1>Two-Factor Authentication</h1>
    <p class="subtitle" id="mode-text">Enter code from your authenticator app</p>

    <div id="status" class="status"></div>

    <input type="text" id="code" placeholder="000000" maxlength="9" autofocus>
    <button id="verify" class="primary">Verify</button>
    
    <div class="toggle">
        <a id="toggle-mode">Use backup code instead</a>
    </div>

    <script>
        const status = document.getElementById('status');
        const codeInput = document.getElementById('code');
        const verifyBtn = document.getElementById('verify');
        const toggleLink = document.getElementById('toggle-mode');
        const modeText = document.getElementById('mode-text');
        let useBackup = false;

        function showStatus(msg) {
            status.textContent = msg;
            status.className = 'status error';
        }

        toggleLink.onclick = () => {
            useBackup = !useBackup;
            if (useBackup) {
                modeText.textContent = 'Enter a backup code';
                codeInput.placeholder = 'XXXX-XXXX';
                codeInput.maxLength = 9;
                toggleLink.textContent = 'Use authenticator app instead';
            } else {
                modeText.textContent = 'Enter code from your authenticator app';
                codeInput.placeholder = '000000';
                codeInput.maxLength = 6;
                toggleLink.textContent = 'Use backup code instead';
            }
            codeInput.value = '';
            codeInput.focus();
        };

        verifyBtn.onclick = async () => {
            verifyBtn.disabled = true;
            try {
                const res = await fetch('/auth/2fa/verify', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        code: codeInput.value,
                        use_backup: useBackup
                    })
                });
                const data = await res.json();
                if (data.success) {
                    window.location.href = '/';
                } else {
                    showStatus(data.error || 'Invalid code');
                }
            } catch (e) {
                showStatus(e.message);
            }
            verifyBtn.disabled = false;
        };

        codeInput.onkeypress = (e) => {
            if (e.key === 'Enter') verifyBtn.click();
        };
    </script>
</body>
</html>
